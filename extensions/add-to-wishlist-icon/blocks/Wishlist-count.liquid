<div class="wishlist-counter" x-data="wishlistCounter()" x-init="init()" @wishlist-updated.window="handleUpdate($event.detail)">
  <button 
    @click="goToWishlist()" 
    class="counter-button"
    :class="{ 'has-items': count > 0 }"
    aria-label="View Wishlist"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
    
    <span class="count-badge" x-show="count > 0" x-text="count"></span>
  </button>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('wishlistCounter', () => ({
    apiUrl: "https://wishlist-remix-app-yxat.onrender.com",
    customerId: "{{ customer.id }}",
    shop: "{{ shop.permanent_domain }}",
    count: 0,
    isLoading: true,

    async init() {
      if (this.customerId && this.shop) {
        await this.fetchCount();
      } else {
        this.count = 0;
        this.isLoading = false;
      }
    },

    async fetchCount() {
      try {
        const response = await fetch(`${this.apiUrl}/api/wishlist?customerId=${this.customerId}&shop=${this.shop}`);
        const data = await response.json();
        this.count = data.wishlists ? data.wishlists.length : 0;
      } catch (error) {
        console.error('Error fetching wishlist count:', error);
        this.count = 0;
      } finally {
        this.isLoading = false;
      }
    },

    handleUpdate(detail) {
      if (detail.action === 'add') {
        this.count++;
      } else if (detail.action === 'remove') {
        this.count--;
      }
    },

    goToWishlist() {
      window.location.href = '/pages/wishlist';
    }
  }));
});
</script>

<style>
.wishlist-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.counter-button {
  position: relative;
  width: 50px;
  height: 50px;
  background-color: #000;
  border: none;
  border-radius: 50%;
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.counter-button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.counter-button.has-items {
  background-color: #dc3545; 
}

.counter-button svg {
  width: 20px;
  height: 20px;
  stroke: #fff;
}

.count-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background-color: #fff;
  color: #000;
  border-radius: 4px; /* Square-like with rounded corners */
  min-width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}
</style>

{% schema %}
{
  "name": "Wishlist Counter",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "wishlist_url",
      "label": "Wishlist Page URL",
      "default": "/apps/wishlist",
      "info": "URL to redirect to on click (default: /apps/wishlist)"
    }
  ]
}
{% endschema %}
